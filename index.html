<!DOCTYPE html>
<html lang="sr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Zakazivanje termina</title>
<style>
  body { font-family: Arial, sans-serif; margin: 10px; }
  #calendar { width: 100%; }

  .week-container {
    margin-bottom: 30px;
    overflow-x: auto;
  }

  .week-table {
    display: grid;
    border: 1px solid #ccc;
    grid-template-columns: 70px repeat(6, 1fr);
    min-width: 600px;
  }

  .cell, .header {
    border: 1px solid #ccc;
    padding: 6px;
    text-align: center;
    font-size: 12px;
    word-wrap: break-word;
  }

  .header-time {
    background-color: #e9ecef;
    font-weight: bold;
    position: sticky;
    left: 0;
    z-index: 2;
  }

  .header-day {
    background-color: #f0f0f0;
    font-weight: bold;
  }

  .free { background-color: #d4edda; color: #155724; }
  .occupied { background-color: #f8d7da; color: #721c24; }

  h2 { text-align: center; margin-bottom: 10px; }

  @media (max-width: 600px) {
    .cell, .header { font-size: 10px; padding: 4px; }
  }
</style>
</head>
<body>

<h2>Pregled slobodnih termina</h2>
<div id="calendar"></div>

<script>
// Radno vreme
const workHoursStart = 10;
const workHoursEnd = 18;
const daysOfWeek = ["Pon", "Uto", "Sre", "Čet", "Pet", "Sub"];

let occupiedSlots = [];

function formatDateSR(date) {
  const d = date.getDate().toString().padStart(2, '0');
  const m = (date.getMonth() + 1).toString().padStart(2, '0');
  const y = date.getFullYear();
  return `${d}.${m}.${y}`;
}

function getDateISO(date) {
  const y = date.getFullYear();
  const m = (date.getMonth() + 1).toString().padStart(2, '0');
  const d = date.getDate().toString().padStart(2, '0');
  return `${y}-${m}-${d}`;
}

function isToday(date) {
  const now = new Date();
  return date.getFullYear() === now.getFullYear() &&
         date.getMonth() === now.getMonth() &&
         date.getDate() === now.getDate();
}

function isPastTodayAfter20h(date) {
  const now = new Date();
  if (!isToday(date)) return false;
  return now.getHours() >= 20;
}

function renderCalendar() {
  const container = document.getElementById("calendar");
  container.innerHTML = "";

  const weeksCount = 4;
  const today = new Date();
  const currentDay = today.getDay() === 0 ? 7 : today.getDay(); // 1=Pon, 7=Ned

  const diffToMonday = (currentDay === 7 ? 6 : currentDay - 1);
  const monday = new Date(today);
  monday.setDate(today.getDate() - diffToMonday);

  for (let w = 0; w < weeksCount; w++) {
    const weekDiv = document.createElement("div");
    weekDiv.className = "week-container";

    const table = document.createElement("div");
    table.className = "week-table";

    // Header reda
    const timeHeader = document.createElement("div");
    timeHeader.className = "header header-time";
    timeHeader.textContent = "Vreme";
    table.appendChild(timeHeader);

    for (let i = 0; i < daysOfWeek.length; i++) {
      const d = new Date(monday);
      d.setDate(monday.getDate() + i + w * 7);

      // Prva nedelja: preskoci dane pre danas + danas posle 20h
      if (w === 0 && (d < today || isPastTodayAfter20h(d))) continue;

      const dayHeader = document.createElement("div");
      dayHeader.className = "header header-day";
      dayHeader.textContent = `${daysOfWeek[i]} ${formatDateSR(d)}`;
      table.appendChild(dayHeader);
    }

    // Redovi sa satima
    for (let hour = workHoursStart; hour <= workHoursEnd; hour++) {
      const timeCell = document.createElement("div");
      timeCell.className = "cell header-time";
      timeCell.textContent = `${hour}:00`;
      table.appendChild(timeCell);

      for (let i = 0; i < daysOfWeek.length; i++) {
        const d = new Date(monday);
        d.setDate(monday.getDate() + i + w * 7);

        if (w === 0 && (d < today || isPastTodayAfter20h(d))) continue;

        const dateISO = getDateISO(d);
        const slotId = `${dateISO}-${hour}`;

        const td = document.createElement("div");
        td.className = "cell";

        if (occupiedSlots.includes(slotId)) {
          td.textContent = "Zauzeto";
          td.classList.add("occupied");
        } else {
          td.textContent = "Slobodno";
          td.classList.add("free");
        }
        table.appendChild(td);
      }
    }

    weekDiv.appendChild(table);
    container.appendChild(weekDiv);
  }
}

function loadOccupiedSlots() {
  fetch('https://script.google.com/macros/s/AKfycbzG-yEMue-zrhDIGlEuPviy2yOqBONJb8fhbx-mXRQbolHiST75ordrTujdzFAXQQzH/exec')
    .then(response => response.json())
    .then(data => {
      occupiedSlots = data.map(item => `${item.Datum}-${item.Sat}`);
      renderCalendar();
    })
    .catch(err => {
      console.error("Greška pri učitavanju API-ja:", err);
      document.getElementById("calendar").innerHTML = "<p style='color:red; text-align:center;'>Greška pri učitavanju termina.</p>";
    });
}

loadOccupiedSlots();
</script>

</body>
</html>
